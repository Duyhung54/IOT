<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mock: IoT RTDB Viewer</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #141c23;
      --border: #243c4a;
      --text: #e2e2e2;
      --muted: #9aa4b2;
      --field: #0b0f14;
      --code: #141c23;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --btn: #2b789c;
      --btnHover: #1c91c7;
    }

    body { font-family: Arial, sans-serif; margin: 18px; background: var(--bg); color: var(--text); }
    .card { max-width: 1100px; border: 1px solid var(--border); background: var(--card); border-radius: 10px; padding: 14px; }
    .row { margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      padding: 8px 12px;
      background: var(--btn);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: var(--btnHover); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    code { background: var(--code); border: 1px solid var(--border); padding: 1px 6px; border-radius: 6px; color: var(--text); }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      min-height: 280px;
    }

    .scroll {
      max-height: 360px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .entries { display: flex; flex-direction: column; gap: 10px; }

    pre {
      background: var(--field);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0;
    }

    .muted { color: var(--muted); font-size: 0.95em; }
    h2, h3 { margin: 8px 0; }
    .badge { padding: 2px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); }
  </style>
  <link rel="icon" href="/favicon.ico" />

</head>

<body>
  <div class="card">
    <h2  style="margin-bottom: 1pt;">MSE IoT Smart Cooling System - Firebase RTDB - Viewer</h2>
    <div class="muted" style="font-style: italic; font-size: x-small; margin-top: 0px; margin-bottom: 12pt;">
      By Nguyen Sy Hung, 2026
    </div>

    <div class="muted">Reads from the same RTDB used by your publisher page.</div>

    <div class="row">
      <button id="btnFetch">Fetch data</button>
      <button id="btnStop" disabled>Stop fetching</button>
      <span id="status" class="warn">Idle</span>
      <span class="badge">sensor_data: <code>/cooling_system/sensor_data</code></span>
      <span class="badge">actuator_cmds: <code>/cooling_system/actuator_cmds</code></span>
    </div>

    <div class="grid">
      <!-- SENSOR PANEL -->
      <div class="panel">
        <h3>cooling_system/sensor_data <span id="sensorCount" class="muted">(0)</span></h3>
        <div class="muted">Shows the last 10 snapshots received (newest first).</div>
        <div class="scroll">
          <div id="sensorList" class="entries">
            <pre>(no data yet)</pre>
          </div>
        </div>
      </div>

      <!-- ACTUATOR PANEL -->
      <div class="panel">
        <h3>cooling_system/actuator_cmds <span id="cmdCount" class="muted">(0)</span></h3>
        <div class="muted">Queries the latest 10 command records ordered by <code>ts</code> (newest first).</div>
        <div class="scroll">
          <div id="cmdList" class="entries">
            <pre>(no data yet)</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Web SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getDatabase,
      ref,
      query,
      orderByChild,
      limitToLast,
      onValue,
      onChildAdded,
      onChildChanged,
      get
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Same config as mock_rtdb_publisher.html (copied directly)
    const firebaseConfig = {
      apiKey: "AIzaSyCauUOWV67DX4pHVzJw9BHaaVqdcbe-RTs",
      authDomain: "mse-iot-smart-home.firebaseapp.com",
      databaseURL: "https://mse-iot-smart-home-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mse-iot-smart-home",
      storageBucket: "mse-iot-smart-home.firebasestorage.app",
      messagingSenderId: "333826794599",
      appId: "1:333826794599:web:1bde93ad6d6e041a57e0c2"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Paths
    const SENSOR_PATH = "cooling_system/sensor_data";
    const ACTUATOR_CMDS_PATH = "cooling_system/actuator_cmds";

    const sensorRef = ref(db, SENSOR_PATH);
    const cmdsRef = ref(db, ACTUATOR_CMDS_PATH);

    // UI
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const sensorListEl = $("sensorList");
    const cmdListEl = $("cmdList");
    const sensorCountEl = $("sensorCount");
    const cmdCountEl = $("cmdCount");
    const btnFetch = $("btnFetch");
    const btnStop = $("btnStop");

    function setStatus(msg, cls) {
      statusEl.textContent = msg;
      statusEl.className = cls || "";
    }

    function pretty(x) {
      return JSON.stringify(x, null, 2);
    }

    function renderList(containerEl, items, formatter) {
      if (!items.length) {
        containerEl.replaceChildren(Object.assign(document.createElement("pre"), { textContent: "(no data yet)" }));
        return;
      }
      const nodes = items.map((it, idx) => {
        const el = document.createElement("pre");
        el.textContent = formatter(it, idx);
        return el;
      });
      containerEl.replaceChildren(...nodes);
    }

    // =============== Fetching state + unsub functions ===============
    let running = false;
    let unsubSensor = null;
    let unsubCmdAdd = null;
    let unsubCmdChg = null;

    // Keep last 10 sensor snapshots locally (because sensor_data is a single node)
    const sensorHist = [];
    let sensorSeq = 0;

    // Keep latest 10 actuator cmds (from query)
    // Map by Firebase push key so updates can replace existing
    const cmdMap = new Map();

    function sortCmdsNewestFirst(arr) {
      // Prefer ts desc; fallback key/time
      return arr.sort((a, b) => {
        const ta = (a?.value?.ts ?? 0);
        const tb = (b?.value?.ts ?? 0);
        if (tb !== ta) return tb - ta;
        return String(b.key).localeCompare(String(a.key));
      });
    }

    function refreshCmdListUI() {
      const arr = Array.from(cmdMap.entries()).map(([key, value]) => ({ key, value }));
      const top10 = sortCmdsNewestFirst(arr).slice(0, 10);

      cmdCountEl.textContent = `(${top10.length})`;

      renderList(cmdListEl, top10, (it, idx) => {
        const header = `#${idx + 1} key=${it.key} ts=${it.value?.ts ?? "?"}`;
        return header + "\n" + pretty(it.value);
      });
    }

    function refreshSensorUI() {
      sensorCountEl.textContent = `(${sensorHist.length})`;

      renderList(sensorListEl, sensorHist, (it, idx) => {
        const header = `#${idx + 1} @ ts=${it.ts ?? "?"}`;
        return header + "\n" + pretty(it.value);
      });
    }

    async function startFetching() {
      if (running) return;
      running = true;

      btnFetch.disabled = true;
      btnStop.disabled = false;

      setStatus("Fetching...", "warn");

      // ---- SENSOR: subscribe to current snapshot; keep local rolling list of 10 ----
      unsubSensor = onValue(sensorRef, (snap) => {
        const v = snap.val();
        if (!v) return;

        const ts = (typeof v.ts === "number") ? v.ts : Math.floor(Date.now() / 1000);
        sensorHist.unshift({ id: ++sensorSeq, ts, value: v });
        if (sensorHist.length > 10) sensorHist.length = 10;

        refreshSensorUI();
        setStatus("Fetching (sensor updated)", "ok");
      }, (err) => {
        setStatus("Sensor listener error: " + err.message, "err");
      });

      // ---- ACTUATOR CMDS: query last 10 ordered by ts, and keep UI updated ----
      const cmdsQ = query(cmdsRef, orderByChild("ts"), limitToLast(10));

      // Populate once immediately (so UI shows something even before child events)
      try {
        const initial = await get(cmdsQ);
        cmdMap.clear();
        initial.forEach((child) => {
          cmdMap.set(child.key, child.val());
        });
        refreshCmdListUI();
      } catch (e) {
        setStatus("Initial cmds query failed: " + e.message, "err");
      }

      // Then listen for incremental adds/changes within that query window
      unsubCmdAdd = onChildAdded(cmdsQ, (snap) => {
        cmdMap.set(snap.key, snap.val());
        // Keep map trimmed-ish (UI shows top 10 anyway, but map should not grow unbounded)
        // Since cmdsQ is limitToLast(10), it shouldn't grow big, but trimming is safe.
        if (cmdMap.size > 12) {
          // remove extras beyond top ~12 by ts
          const arr = Array.from(cmdMap.entries()).map(([key, value]) => ({ key, value }));
          const keep = sortCmdsNewestFirst(arr).slice(0, 12).map(x => x.key);
          for (const k of Array.from(cmdMap.keys())) {
            if (!keep.includes(k)) cmdMap.delete(k);
          }
        }
        refreshCmdListUI();
      }, (err) => {
        setStatus("Cmd add listener error: " + err.message, "err");
      });

      unsubCmdChg = onChildChanged(cmdsQ, (snap) => {
        cmdMap.set(snap.key, snap.val());
        refreshCmdListUI();
      }, (err) => {
        setStatus("Cmd change listener error: " + err.message, "err");
      });

      setStatus("Fetching âœ…", "ok");
    }

    function stopFetching() {
      if (!running) return;
      running = false;

      btnFetch.disabled = false;
      btnStop.disabled = true;

      try { if (typeof unsubSensor === "function") unsubSensor(); } catch {}
      try { if (typeof unsubCmdAdd === "function") unsubCmdAdd(); } catch {}
      try { if (typeof unsubCmdChg === "function") unsubCmdChg(); } catch {}

      unsubSensor = unsubCmdAdd = unsubCmdChg = null;

      setStatus("Stopped", "warn");
    }

    btnFetch.addEventListener("click", startFetching);
    btnStop.addEventListener("click", stopFetching);

    // optional: auto-start
    // startFetching();
  </script>
</body>
</html>
